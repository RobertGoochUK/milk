<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Project MILK</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <style>
        .gray-small-button { background:lightgray;padding:10px; }
        .outputBox { border-style:solid; border-width:1px; width:600px; padding:10px; font-family:courier; }
        .outputCUIBox { border-style:solid; border-width:1px; width:600px; padding:10px; font-family:Helvetica; }
    </style>
  </head>
  
<script type='text/javascript'>

function callGetConceptForm(divName) {

    var id = document.getElementById("listConcepts").value;
    
    var outputType = "json";
    if ( document.getElementById("ot2-xml").checked == true ) {
        outputType = "xml";
    }
    
    var outputFormat = "complete";
    if ( document.getElementById("of-summary").checked == true ) {
        outputFormat = "summary";
    } else {
        if ( document.getElementById("of-careconnect-medication-1").checked == true ) {
            outputFormat = "careconnect-medication-1";
        }
    }
    
    var uri = "getConcept.php?id=" + id + "&ot=" + outputType + "&of=" + outputFormat;
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            document.getElementById(divName).innerHTML = this.responseText;
        }
    };
    xmlhttp.open("GET", uri, true);
    xmlhttp.send();
}

function callGetProductsForm(divName) {

    var sortOrder = "alpha";
    if ( document.getElementById("so-divide").checked == true ) {
        sortOrder = "divide";
    }
    
    var outputType = "json";
    if ( document.getElementById("ot-xml").checked == true ) {
        outputType = "xml";
    }
    
   var myElement = document.getElementById("dosage");
   var uri = "getProducts.php?so=" + sortOrder + "&ot=" + outputType + "&d=" + encodeURIComponent(myElement.value);
   var xmlhttp = new XMLHttpRequest();
   xmlhttp.onreadystatechange = function() {
       if (this.readyState == 4 && this.status == 200) {
           document.getElementById(divName).innerHTML = this.responseText;
       }
   };
   xmlhttp.open("GET", uri, true);
   xmlhttp.send();
}

function callGetDosageTextForm(out,divName) {
    
    var myElement = document.getElementById("dosage");
    var uri = "getDosageText.php?o=" + out + "&d=" + encodeURIComponent(myElement.value);
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            document.getElementById(divName).innerHTML = this.responseText;
        }
    };
    xmlhttp.open("GET", uri, true);
    xmlhttp.send();
}

function showExample() {
    var uri = document.getElementById("examplesList").value;
    if ( uri > "" ) {
        xmlhttp = new XMLHttpRequest();
        xmlhttp.open('GET', uri, false);
        xmlhttp.send();
        document.getElementById("dosage").value = xmlhttp.responseText;
    } else {
        document.getElementById("dosage").value = "";
    }
}

</script>

<body>
    
<h1>Project MILK: Medicines Interoperability and Logic Toolkit</h1>

<h3><span style="color:red;">Alpha v1.0.6</span></h3>

<p>These web services are for demonstration or experimental use only.<br/>They are not (yet) implemented on production quality infrastructure and are subject to change without notice.<br/>Jump to the <a href="#relNotes">Release Notes</a>. Source code on <a href="https://github.com/RobertGoochUK/milk">GitHub</a>. Join the <a href="https://interopen.ryver.com/index.html#forums/1276343">INTEROPen discussion</a>.</p>

<h2>Step 1: FHIR Source XML Data</h2>

<div style="background:#EEEEEE;padding:10px;">
    <p>
    Try <a href="https://developer.nhs.uk/apis/dose-syntax-implementation/dosage-examples-overview.html">examples</a> from the Dose Syntax Implementation Guidance:
    <select name="examplesList" id="examplesList" onChange='showExample();'>
        <option value="">(clear)</option>
        <option value="https://gist.githubusercontent.com/RobertGoochUK/2b88fe64156c2d3c788328463d7a4a5d/raw/">[Product] Oxytetracycline, oral</option>
        <option value="https://gist.githubusercontent.com/RobertGoochUK/3d90859ce98769ec9b6643cfccdcc65a/raw/">[Dose] Oxytetracycline, oral</option>
        <option value="https://gist.githubusercontent.com/RobertGoochUK/b80afd58861658643c8265d3cb622979/raw/">[Product] Omeprazole, gastro-resistant, oral</option>
        <option value="https://gist.githubusercontent.com/RobertGoochUK/3058adde9517ffb68a62f55112e036f0/raw/">[Dose] Salbutamol, inhalation</option>
        <option value="https://gist.githubusercontent.com/RobertGoochUK/17e0acb88b76bbcb82b3b6f6c34d7f31/raw/">[Dose] Flucloxacillin, oral</option>
        <option value="https://gist.githubusercontent.com/RobertGoochUK/94b057717c3ade14ae6d6227bd52c213/raw/">[Dose] Prednisolone, tapered</option>
    <select>
    <br/>
    Or just type/paste valid FHIR XML into the box below.
    </p>
    <p>
    <textarea rows="10" cols="100" name="dosage" id="dosage"></textarea>
    </p>
</div>

<h2>Step 2: Execute a MILK web service</h2>

<div style="background:white;padding:10px;">
    <h3>Function: getDosageText</h3>
    <p>Returns an appropriate human readable dosage string generated from the given FHIR Dosage structure. Use to populate the .text structure within profiled resources like <a href="https://fhir.hl7.org.uk/STU3/StructureDefinition/CareConnect-MedicationRequest-1">CareConnect-MedicationRequest-1</a>.</p>
    <p>
    <button type="button" onclick="callGetDosageTextForm('text','divOutputBox')" class="gray-small-button">Plain Text</button>
    &nbsp;
    <span style="font-family:courier;">{base_url}/getDosageText.php?o=text&d={urlencoded FHIR XML}</span>
    </p>
    <div name="divOutputBox" id="divOutputBox" class="outputBox"></div>
    <p>
    Now execute the web service and request a formatted HTML response aligned with CUI guidance.
    </p>
    <p>
    <button type="button" onclick="callGetDosageTextForm('html','divOutputCUIBox1')" class="gray-small-button">HTML Multi Line</button>
    &nbsp;<span style="font-family:courier;">{base_url}/getDosageText.php?o=html&d={urlencoded FHIR XML}</span>
        </p>
        <div name="divOutputCUIBox1" id="divOutputCUIBox1" class="outputCUIBox"></div>
        <p>
        <button type="button" onclick="callGetDosageTextForm('htmlinline','divOutputCUIBox2')" class="gray-small-button">HTML Single Line</button>
        &nbsp;<span style="font-family:courier;">{base_url}/getDosageText.php?o=htmlinline&d={urlencoded FHIR XML}</span>
    </p>
    <div name="divOutputCUIBox2" id="divOutputCUIBox2" class="outputCUIBox"></div>
</div>

<br/>

<div style="background:#EEEEEE;padding:10px;">
 	<h3>Function: getProducts (stubbed)</h3>
	<p>Return a list of VMP or AMP concepts (name + id) that could fulfil the given dose-based instruction comprising of at least a VTM and coded Route, plus optional data of a coded Form, Trade Family SNOMED code and dose strength quantity and unit of measure. The returned list can be sorted alphabetically or in order of least divisiblity, i.e. least quantity of the product to meet the ordered dose strength. Any additional filtering subject to local requirements, e.g. stock availability, formulary etc. It is not intended that this process auto-selects a single product. A human will ultimately decide on which product to use to fulfil the clinical need.</p>
    <div style="float:left; padding:10px; ">
        Output Type (ot)<br>
        <input type="radio" id="ot-json" name="ot" value="json" checked>json</input><br>
        <input type="radio" id="ot-xml" name="ot" value="xml">xml</input>
    </div>
    <div style="float:left; padding:10px; ">
        Sort Order (so)<br>
        <input type="radio" id="so-alpha" name="so" value="alpha" checked>alphabetical</input><br>
        <input type="radio" id="so-divide" name="so" value="divide">least divisibility</input>
    </div>
    <div style="float:left; padding:10px; ">
        <button type="button" onclick="callGetProductsForm('divOutputProducts')" class="gray-small-button">Execute</button>
    </div>
    <div style="float:none; padding:10px; ">
        <span style="font-family:courier;">{base_url}/getProducts.php?ot={output_type}&so={sort_order}&d={urlencoded FHIR XML}</span>
    </div>
    <br/><br/>
    <div style="float:none; padding:10px; ">
        <textarea rows="10" cols="100" name="divOutputProducts" id="divOutputProducts" class="outputBox"></textarea>
    </div>
</div>

<br/>

<div style="background:#EEEEEE;padding:10px;">
    <h3>Function: getConcept (stubbed)</h3>
    <p>Return information for the given dm+d concept id. Allows someone without dm+d or SNOMED-CT embedded within their software to experiment with medicines data. Option to return data formatted within a CareConnect profiled resource.</p>
    <div style="float:none; padding:10px; ">
        <select name="listConcepts" id="listConcepts">
            <option value="318902004">Ramipril 5mg capsules | 318902004</option>
            <option value="22969001">Oxytetracycline | 22969001</option>
            <option value="324095003">Oxytetracycline 250mg tablets | 324095003</option>
            <option value="91143003">Salbutamol | 91143003</option>
            <option value="407846000">Omeprazole 10mg gastro-resistant tablets | 407846000</option>
        <select>
    </div>
    <div style="float:left; padding:10px; ">
        Output Type (ot)<br>
        <input type="radio" id="ot2-json" name="ot2" value="json" checked>json</input><br>
        <input type="radio" id="ot2-xml" name="ot2" value="xml">xml</input>
    </div>
    <div style="float:left; padding:10px; ">
        Output Format (of)<br>
        <input type="radio" id="of-complete" name="of" value="complete" checked>complete</input><br>
        <input type="radio" id="of-summary" name="of" value="summary">summary</input><br>
        <input type="radio" id="of-careconnect-medication-1" name="of" value="careconnect-medication-1">careconnect-medication-1</input>
    </div>
    <div style="float:left; padding:10px; ">
        <button type="button" onclick="callGetConceptForm('divOutputConcept')" class="gray-small-button">Execute</button>
    </div>
    <div style="float:none; padding:10px; ">
        <span style="font-family:courier;">{base_url}/getConcept.php?id={concept_id}&ot={output_type}&of={output_format}</span>
    </div>
    <br/><br/><br/>
    <div style="float:none; padding:10px; ">
        <textarea rows="10" cols="100" name="divOutputConcept" id="divOutputConcept" class="outputBox"></textarea>
    </div>
</div>

<!--
<br/>

<div style="background:#EEEEEE;padding:10px;">
 	<h2>Function: getToBeNamed</h2>
	<p>Convert a product-based instruction (VMP or AMP) into a dose-based instruction using a VTM.</p>
	<p>Drafting Notes....The first part is simple by going to the parent VTM. Need to use the Medicines Framework information to identify the safe minimum dataset.</p>
	<p>
</div>
-->

<a name="relNotes"></a>
<div style="background:#CCCCCC;padding:5px;font-size:smaller;">
    <h2>Release Notes</h2>
    <h3>Alpha v1.0.6</h3>
    <p><span style="font-weight:bold;">Change History</span>: TBC</p>
    <p><span style="font-weight:bold;">Known Issues</span>: TBC</p>
    <h3>Alpha v1.0.5</h3>
    <p><span style="font-weight:bold;">Change History</span>: Function getDosageText now as a true web service.</p>
    <p><span style="font-weight:bold;">Known Issues</span>: HTML Single Line output for multi-sequence instructions not working.</p>
</div>

</body>
</html>
